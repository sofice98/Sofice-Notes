# 💦 如何实现 MySQL 的读写分离

---

高并发这个阶段，肯定是做读写分离的，因为**实际上大部分的网站或者是 app 其实都是读多写少**。针对这个情况，**利用读写分离可以大幅提升读的性能，从而支撑更高的读并发压力了**

## 1. 如何实现 MySQL 的读写分离

其实很简单，就是基于 MySQL 自带的**主从复制**功能（不需要额外的第三方软件就可以实现），简单来说，就是搞一个主库，挂多个从库，然后我们就只需要写主库，主库会自动把数据给同步到从库上去。即从库用来读，主库用来写。

<img src="https://gitee.com/veal98/images/raw/master/img/20201125212845.png" style="zoom: 67%;" />

## 2. MySQL 主从复制的原理

💡 **MySQL 主从复制的原理**：

![](https://gitee.com/veal98/images/raw/master/img/20201125213342.png)

- 首先主库将变更写入 `Binlog` （**binary log 二进制日志文件**）
- 从库连接到主库之后，从库有一个 **【IO 线程】**，将主库的 `Binlog` 拷贝到自己本地，写入一个 `Relay Log` （**中继日志**）中
- 接着从库中有一个 **【SQL 线程】**会从 `Relay Log` 中读取  `Binlog`，然后执行 `Binlog` 日志中的内容，也就是在自己本地再次执行一遍 SQL，这样就可以保证自己跟主库的数据是一样的

😓 **MySQL 主从复制引发的两个问题**：

- 🚨 **【主从同步延时问题】**：<u>从库同步主库数据的过程是串行化的，也就是说主库上并行的操作，在从库上会串行执行</u>。由于从库从主库拷贝日志以及串行执行 SQL 的特点，<u>在高并发场景下，从库的数据一定会比主库慢一些，是有延时的</u>。所以经常出现，刚写入主库的数据可能是读不到的，要过几十毫秒，甚至几百毫秒才能读取到。

- 🚨 **【主库数据丢失问题】**：<u>如果主库突然宕机，而且恰好数据还没同步到从库，那么有些数据可能在从库上是没有的，有些数据可能就丢失了</u>。

👍 MySQL 为了解决这两个问题有两个机制：

- 一个是 **【半同步复制 `semi-sync`】**，用来解决 主库突然宕机且恰好数据还没同步到从库 导致的 **主库数据丢失问题**

  主库写入 `Binlog` 之后，就会**强制**立即将数据同步到从库，从库将日志写入自己本地的 `Relay Log` 之后，接着会返回一个 ack 给主库，**主库接收到至少一个从库的 ack 之后才会认为写操作完成了**。

- 一个是 **【并行复制】**，用来解决 从库串行 导致的 **主从同步延时问题**

  指的是**从库开启多个线程**，并行读取 `Relay log` 中不同库的日志，然后**并行的重新执行不同库的日志**，这是库级别的并行。

## 3. 解决主从同步延时问题

上文我们已经说过，所谓主从同步延时就是：高并发场景下，刚写入主库的数据在从库上可能是读不到的，要过几十毫秒，甚至几百毫秒才能读取到。

**MySQL 主从延时排查方法**：

MySQL 有主从同步的状态信息，可以通过 MySQL 命令 `show slave status` 获取，除了获知当前是否主从同步正常工作，另外一个重要指标就是 `Seconds_Behind_Master`，根据输出的 `Seconds_Behind_Master` 参数的值来判断：

- `NULL`：表示 io_thread 或是 sql_thread 有任何一个发生故障
- `0`：该值为零，表示主从复制良好
- `正值`：表示主从已经出现延时，数字越大表示从库延迟越严重

一般来说，如果主从延迟较为严重，有以下**解决方案**：

- ① **分库，将一个主库拆分为多个主库**：每个主库的写并发就减少了几倍，此时主从延迟可以忽略不计

- ② 上文我们已经说过，MySQL 支持的 **并行复制** 机制，多个库并行复制。

  > 🚨  如果说某个库的写入并发特别高，单库写并发达到了 2000/s，并行复制还是没意义。

- ③ **重写代码**：写代码时考虑插入数据后可能无法立即查询到。

- ④ **升级从库**硬件配置

## 4. MySQL 主从复制实例

对于主从库，如果没有多台服务器的话，我们可以**在同一台电脑的不同的路径下安装两个 MySQL**。建议这里主从两个 MySQL 的安装版本一致

具体实现过程请参见该篇文章 👉 [MySQL 主从复制的实现过程](https://www.cnblogs.com/cocoxu1992/p/10670589.html)

## 📚 References

- [Github - JavaGuide](https://snailclimb.gitee.io/javaguide/#/?id=%e7%bc%96%e7%a0%81%e4%b9%8b%e9%81%93%e5%bf%85%e7%9c%8b-1)