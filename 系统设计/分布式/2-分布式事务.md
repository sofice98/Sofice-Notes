# 🌝 分布式事务

---

分布式事务简单的说，就是一次大的操作由不同的小操作组成，这些小的操作分布在不同的服务器上，且属于不同的应用，分布式事务需要保证这些小操作的 ACID 特性。本质上来说，分布式事务就是为了保证不同数据库的数据一致性。

在分布式系统中，要实现分布式事务，无外乎以下几种**解决方案**：👇

## 1. 两阶段提交 2PC

两阶段提交（Two-phase Commit，2PC），通过引入协调者（Coordinator）来协调参与者的行为，并最终决定这些参与者是否要真正执行事务。

- **准备阶段**

  协调者询问参与者事务是否执行成功，参与者发回事务执行结果。询问可以看成一种投票，需要参与者都同意才能执行。

  <img src="https://gitee.com/veal98/images/raw/master/img/20201122172237.png" style="zoom: 80%;" />

- **提交阶段**

  如果事务在每个参与者上都执行成功，事务协调者发送通知让参与者提交事务；否则，协调者发送通知让参与者回滚事务。

  需要注意的是，<u>在准备阶段，参与者执行了事务，但是还未提交。只有在提交阶段接收到协调者发来的通知后，才进行提交或者回滚。</u>

  <img src="https://gitee.com/veal98/images/raw/master/img/20201122172334.png" style="zoom: 80%;" />

😒 两阶段提交这种解决方案存在一定的问题：

- **同步阻塞**

  所有事务参与者在等待其它参与者响应的时候都处于同步阻塞等待状态，无法进行其它操作。

- **单点问题**

  协调者在 2PC 中起到非常大的作用，发生故障将会造成很大影响。特别是在提交阶段发生故障，所有参与者会一直同步阻塞等待，无法完成其它操作。

- **数据不一致**

  在提交阶段，如果协调者只发送了部分 Commit 消息，此时网络发生异常，那么只有部分参与者接收到 Commit 消息，也就是说只有部分参与者提交了事务，使得系统数据不一致。

- **太过保守**

  任意一个节点失败就会导致整个事务失败，没有完善的容错机制。

## 2. 补偿事务 TCC

TCC 其实就是采用的补偿机制，**其核心思想是：针对每个操作，都要注册一个与其对应的确认和补偿（撤销）操作**。它分为三个阶段：

- `Try` 阶段主要是对业务系统做检测及资源预留
- `Confirm` 阶段主要是对业务系统做确认提交，Try 阶段执行成功并开始执行 Confirm 阶段时，默认 Confirm 阶段是不会出错的。即：只要 Try 成功，Confirm 一定成功。
- `Cancel` 阶段主要是在业务执行错误，需要回滚的状态下执行的业务取消，预留资源释放。

举个例子，假入 Bob 要向 Smith 转账，思路大概是：

我们有一个本地方法，里面依次调用

- 1、首先在 Try 阶段，要先调用远程接口把 Smith 和 Bob 的钱给冻结起来。
- 2、在 Confirm 阶段，执行远程调用的转账的操作，转账成功进行解冻。
- 3、如果第 2 步执行成功，那么转账成功，如果第二步执行失败，则调用远程冻结接口对应的解冻方法 (Cancel)。

<img src="https://gitee.com/veal98/images/raw/master/img/20201122210453.png" style="zoom:50%;" />

**优点：** 跟 2PC 比起来，实现以及流程相对简单了一些，但数据的一致性比 2PC 也要差一些

**缺点：** 缺点还是比较明显的，在 2,3 步中都有可能失败。TCC 属于应用层的一种补偿方式，所以需要程序员在实现的时候多写很多补偿的代码，在一些场景中，一些业务流程可能用 TCC 不太好定义及处理。

这种方案几乎很少人使用，但是也有使用的场景。一般来说跟**钱**相关的，跟钱打交道的，**支付**、**交易**相关的场景，我们会用 TCC，严格保证分布式事务要么全部成功，要么全部自动回滚，严格保证资金的正确性，保证在资金上不会出现问题。

## 3. 本地消息表（异步确保）

本地消息表这种实现方式应该是业界使用最多的，**其核心思想是将分布式事务拆分成本地事务进行处理，这种方案遵循 BASE 理论，采用的是最终一致性**

<u>本地消息表与业务数据表处于同一个数据库中，这样就能利用本地事务来保证在对这两个表的操作满足事务特性，并且使用了消息队列来保证最终一致性。</u>

<img src="https://gitee.com/veal98/images/raw/master/img/20201122173226.png" style="zoom:80%;" />

1. 在分布式事务操作的一方完成写业务数据的操作之后向本地消息表发送一个消息，本地事务能保证这个消息一定会被写入本地消息表中。
2. 之后将本地消息表中的消息转发到消息队列中，如果转发成功则将消息从本地消息表中删除，否则继续重新转发。
3. 在分布式事务操作的另一方从消息队列中读取一个消息，并执行消息中的操作。