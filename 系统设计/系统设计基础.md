# 系统架构演进

## 1、单体架构

早期将所有的服务端模块打包成单个巨石型应用，局部改动就要重新部署，也不易于扩展。

## 2、垂直分层架构

为了提升机器利用率和性能，将大应用垂直划分为多个层，如MVC。优点是项目架构简单，前期开发成本低。缺点是对于大型项目不易开发、扩展及维护；系统性能扩展只能通过扩展集群节点实现，成本高且有瓶颈。

## 3、SOA（Service Oriented Architecture， 面向服务架构）

当垂直架构拆分的应用越来越多，就会出现多个应用都依赖的业务逻辑组件。此时就需要将通用的业务组件独立出来，向外提供服务。

SOA是一个组件模型，它将不同的服务通过独立于环境（硬件、操作系统、编程语言）的接口联系起来，使得各种系统的服务可以以一种统一的方式交互。

==SOA 设计原则==：

- 明确定义的接口。服务请求者依赖于服务规约来调用服务，因此，服务定义必须长时间稳定，一旦公布，不能随意更改；服务的定义应尽可能明确，减少请求者的不适当使用；不要让请求者看到服务内部的私有数据。
- 自包含和模块化。服务封装了那些在业务上稳定、重复出现的活动和构件，实现服务的功能实体是完全独立自主的，独立进行部署、版本控制、自我管理和恢复。
- 粗粒度。服务数量不应该太多，依靠消息交互而不是远程过程调用，通常消息量比较大，但是服务之间的交互频度较低。
- 松耦合。服务请求者可见的是服务的接口，其位置、实现技术、当前状态和私有数据等，对服务请求者而言是不可见的。
- 互操作性、兼容和策略声明。为了确保服务规约的全面和明确，策略成为一个越来越重要的方面。这可以是技术相关的内容，例如，一个服务对安全性方面的要求；也可以是与业务有关的语义方面的内容，例如，需要满足的费用或者服务级别方面的要求，这些策略对于服务在交互时是非常重要的。

SOA 适用于大型软件服务企业对外提供服务的场景，对于一般业务场景并不适用，业务总线也容易导致系统单点风险。

## 4、微服务架构（Microservices Architecture Pattern）

将业务系统彻底组件化，模块化，每个服务运行在其独立的进程中，服务与服务间采用轻量级的通信机制互相沟通（Dubbo 采用 RPC，Spring Cloud 采用基于 HTTP 协议的 RESTful API）。每个服务都围绕着具体业务进行构建，并且能够被独立的部署到生产环境。

尽量避免统一的、集中式的服务管理机制，对具体的一个服务而言，应根据业务上下文，选择合适的语言、工具对其进行构建。

⭐ 一个分布式微服务架构的系统，最起码需要包含如下组件：

<img src="http://mdimg.sofice.top/202112271455597.png" style="zoom: 25%;" />

==六大设计原则==：

1. 高内聚，低耦合：单一职责，轻量级通信。
2. 高度自治：能独立部署、开发、发布，进程隔离，独立的代码库、流水线。
3. 以业务为中心：每个服务代表特定的业务逻辑，有明显的边界上下文，围绕业务组织团队，能快速的相应业务变化。
4. 弹性设计：可容错，服务降级，防止级联的服务雪崩。
5. 日志与监控：日志聚合，做到监控和警告。
6. 自动化：持续集成，持续交付。

==优势与特点==：单个微服务的技术异构性，弹性，易扩展，简化部署，细粒度，与组织结构相匹配

==挑战==（**本质是网络不可靠**）：分布式复杂度高（服务雪崩），运维成本高，部署需要自动化，团队管理需与DevOps相结合

- 客户端如何访问这些服务？API网管，服务路由
- 服务之间如何通信？RestFul，RPC，异步调用
- 服务如何治理？服务注册与发现，ZooKeeper
- 服务挂了？熔断机制，服务降级



:question: 微服务和分布式区别

微服务是分散能力（抽象结构），分布式是分散压力（物理结构）。微服务不一定运行在分布式系统上。



**常见的微服务架构解决方案**

- Spring Cloud Alibaba，Spring Cloud NetFlix(zuul, Eureka, Hystrix，**已弃用**)

  Spring Cloud 是分布式微服务架构的一站式解决方案，是多种微服务架构落地技术的集合体。Spring Cloud 本身其实只是一套微服务规范，并不是一个拿来即可用的框架，Spring Cloud Netflix 和 Spring Cloud Alibaba 是为开发者提供了这套规范的实现方式。

  以下红框圈出来的表示推荐使用的组件：(2020/11/24)

  ![](http://mdimg.sofice.top/202112271500601.png)

- Dubbo + zookeeper

  Dubbo + Zookeeper 其实也是一种微服务架构的解决方案，但是并非是一站式解决方案，还需要整合其他组件。

- Go Kit，Go Micro

### 领域驱动设计（DDD）



### 服务网格（Server Mesh）

下一代微服务标准，istio









<img src="http://mdimg.sofice.top/202112111343292.png" alt="img" style="zoom:130%;" />

<img src="http://mdimg.sofice.top/202112111343237.png" alt="img" style="zoom:130%;" />

## 5、云原生架构

应用程序最终部署在云上，并依赖云服务提供的分布式或其他基础架构。

**四要素**：微服务，容器化，DevOps，持续交付

依托**PaaS**支持整个服务开发、发布、运维：

- Codeless：服务开发。实现源码托管，工程师只需关注代码实现，不需要关心代码库和代码分支。
- Applicationless：服务发布。不需要再申请应用发布权限，也不用关心如何发布。
- Serverless：服务运维。不需要关注机器资源，可以自动弹性扩容。

云原生API不是跨云平台的，切换存在成本。





# 分布式数据库

数据库的瓶颈：

1. 数据量太大，一个机器硬盘放不下
2. 数据的索引（B+Tree），一个机器内存放不下
3. 访问量（读写混合），一个服务器承受不了

演化：

1. 原本：APP-DAL-数据库

   <img src="http://mdimg.sofice.top/202112111343605.png" style="zoom:50%;" />

2. 访问重复：加缓存（Memcached） APP-DAL-Cache-数据库

3. 一张表太大：水平拆分

4. 业务复杂：垂直拆分

   <img src="http://mdimg.sofice.top/202112111344278.png" alt="img" style="zoom:67%;" />

5. 读比写多：读写分离

   <img src="http://mdimg.sofice.top/202112111344455.png" alt="img" style="zoom:67%;" />

6. 数据量多，类型多，大数据的IO压力下表无法更改：NoSQL

   



**大数据时代的 3 V**：主要是描述问题的

- 海量 Volume
- 多样 Variety
- 实时 Velocity

**大数据时代的 3 高**：主要是对程序的要求

- 高并发
- 高可扩
- 高性能





# 大型网站核心架构要素

**软件架构 software architecture**：<u>有关软件整体结构与组件的抽象描述，用于指导大型软件系统各个方面的设计。</u>软件架构是一个系统的草图。软件体系结构是构建计算机软件实践的基础。

一般来说，除了当前的系统功能需求外，软件架构还需要关注性能、可用性、伸缩性、扩展性和安全性这 5 个架构要素。架构设计过程中需要平衡这 5 个要素之间的关系以实现需求和架构目标，也可以通过考察这些架构要素来衡量一个软件架构设计的优劣。

## 性能

### ① 性能指标

#### 响应时间

指某个请求从发出到接收到响应消耗的时间。

在对响应时间进行测试时，通常采用重复请求的方式，然后计算平均响应时间。

#### 吞吐量

指系统在单位时间内可以处理的请求数量，通常使用每秒的请求数来衡量。

#### 并发用户数

指系统能同时处理的并发用户请求数量。

在没有并发存在的系统中，请求被顺序执行，此时响应时间为吞吐量的倒数。例如系统支持的吞吐量为 100 req/s，那么平均响应时间应该为 0.01s。

目前的大型系统都支持多线程来处理并发请求，多线程能够提高吞吐量以及缩短响应时间，主要有两个原因：

- 多 CPU
- IO 等待时间

使用 IO 多路复用等方式，系统在等待一个 IO 操作完成的这段时间内不需要被阻塞，可以去处理其它请求。通过将这个等待时间利用起来，使得 CPU 利用率大大提高。

并发用户数不是越高越好，因为如果并发用户数太高，系统来不及处理这么多的请求，会使得过多的请求需要等待，那么响应时间就会大大提高。

### ② 性能优化

#### 集群

将多台服务器组成集群，使用负载均衡将请求转发到集群中，避免单一服务器的负载压力过大导致性能降低。

#### 缓存

缓存能够提高性能的原因如下：

- 缓存数据通常位于内存等介质中，这种介质对于读操作特别快；
- 缓存数据可以位于靠近用户的地理位置上；
- 可以将计算结果进行缓存，从而避免重复计算。

#### 异步

某些流程可以将操作转换为消息，将消息发送到消息队列之后立即返回，之后这个操作会被异步处理。

## 2. 可用性

<img src="https://gitee.com/veal98/images/raw/master/img/20201122152240.png" style="zoom: 40%;" />

💧 保证网站高可用的手段主要有：

- 冗余
- 监控
- 服务降级

### ① 冗余

保证高可用的主要手段是使用冗余，**当某个服务器故障时就请求其它服务器**。

应用服务器的冗余比较容易实现，只要保证应用服务器不具有状态，那么某个应用服务器故障时，负载均衡器将该应用服务器原先的用户请求转发到另一个应用服务器上，不会对用户有任何影响。

**存储服务器的冗余需要使用主从复制来实现，当主服务器故障时，需要提升从服务器为主服务器，这个过程称为切换。**

### ② 监控

对 CPU、内存、磁盘、网络等系统负载信息进行监控，<u>当某个信息达到一定阈值时通知运维人员，从而在系统发生故障之前及时发现问题</u>。

### ③ 服务降级

服务降级是系统为了应对大量的请求，<u>主动关闭部分功能，从而保证核心功能可用</u>。

## 3. 伸缩性

所谓伸缩性就是指**不断向集群中添加服务器，来缓解不断上升的用户并发访问压力和不断增长的数据存储需求**。

### ① 衡量伸缩性的标准

<img src="https://gitee.com/veal98/images/raw/master/img/20201122152736.png" style="zoom:40%;" />

### ② 实现伸缩性

<img src="https://gitee.com/veal98/images/raw/master/img/20201122152908.png" style="zoom:40%;" />

## 4. 扩展性

所谓扩展性指的是**添加新功能时对现有系统的其它应用无影响，这就要求不同应用具备低耦合的特点**。

实现可扩展主要有两种方式：

- 使用**消息队列**进行解耦，应用之间通过消息传递进行通信；
- 使用**分布式服务**将业务和可复用的服务分离开来，业务使用分布式服务框架调用可复用的服务。新增的产品可以通过调用可复用的服务来实现业务逻辑，对其它产品没有影响。

## 5. 安全性

所谓安全性就是**保护网站不受恶意访问和攻击，保护网站的重要数据不被窃取**。





































